/*CREATE DATABASE Final_SQL COLLATE Latin1_General_100_CI_AI_SC_UTF8*/
USE Final_SQL;
CREATE TABLE LOAIKH(
    MaLoaiKH VARCHAR(50) PRIMARY KEY,
    TenLoaiKH VARCHAR(100) NOT NULL
);
CREATE TABLE KHACHHANG(
    MaKH VARCHAR(50) PRIMARY KEY,
    HoTen VARCHAR(150) NOT NULL,
    CCCD INT NOT NULL,
    GioiTinh VARCHAR(5) NOT NULL,
    NgaySinh VARCHAR(30) NOT NULL,
    DiaChi VARCHAR(100) NOT NULL,
    SoDienThoai VARCHAR(14) NOT NULL,
    MaLoaiKH VARCHAR(50) FOREIGN KEY REFERENCES LOAIKH(MaLoaiKH) NOT NULL
);
CREATE TABLE PHONG(
    MaPhong VARCHAR(50) PRIMARY KEY,
    SoHieuPhong INT NOT NULL,
    LoaiPhong VARCHAR(20) NOT NULL,
    GiaPhong INT NOT NULL,
    KhuVuc VARCHAR(20)  
);
CREATE TABLE DKLUUTRU(
    MaLT VARCHAR(50) PRIMARY KEY,
    MaKH VARCHAR(50) FOREIGN KEY REFERENCES KHACHHANG(MaKH) NOT NULL,
    NgayBD VARCHAR(20) NOT NULL,
    NgayKT VARCHAR(20) NOT NULL,
    MaPhong VARCHAR(50) FOREIGN KEY REFERENCES PHONG(MaPhong) NOT NULL,
    TongTien INT
);
CREATE TABLE DICHVU(
    MaDV VARCHAR(50) PRIMARY KEY,
    TenDV VARCHAR(100) NOT NULL,
    GiaTien INT NOT NULL
);
CREATE TABLE CTDICHVU(
    MaCT VARCHAR(50) PRIMARY KEY,
    MaLT VARCHAR(50) FOREIGN KEY REFERENCES DKLUUTRU(MaLT) NOT NULL,
    MaDV VARCHAR(50) FOREIGN KEY REFERENCES DICHVU(MaDV) NOT NULL,
    NgaySD VARCHAR(20) NOT NULL
);

INSERT INTO LOAIKH(MaLoaiKH, TenLoaiKH) VALUES 
('LKH001','VIP'),
('LKH002','Gold'),
('LKH003','Silver'),
('LKH004','Vang lai');
INSERT INTO KHACHHANG(MaKH, HoTen, CCCD, GioiTinh, NgaySinh, DiaChi, SoDienThoai, MaLoaiKH) VALUES 
('KH001','A',325425,'Nam','02-08-1982','76 CMT8','0957482790','LKH001'),
('KH002','B',950295,'Nam','05-01-1978','12 Ha Huy Tap','0957480998','LKH002'),
('KH003','C',125351,'Nu','05-05-1978','342 TG','0952432743','LKH003'),
('KH004','D',123453,'Nu','10-14-1999','776 YU','0957482434','LKH001'),
('KH005','E',123241,'Nam','10-14-1995','1 IO','0953433431','LKH002'),
('KH006','F',123522,'Nam','10-14-1990','145 MK','0957482740','LKH003');
INSERT INTO PHONG(MaPhong, SoHieuPhong, LoaiPhong, GiaPhong, KhuVuc) VALUES 
('P001',103,'Twin',10000000,'A'),
('P002',207,'Single',100000,'B'),
('P003',302,'Single',20000000,'A'),
('P004',314,'Twin',50000000,'C');
INSERT INTO DKLUUTRU(MaLT, MaKH, NgayBD, NgayKT, MaPhong, TongTien) VALUES 
('LT001','KH001','3-7-2022','4-7-2022','P001',300000),
('LT002','KH002','2-7-2022','3-7-2022','P002',250000),
('LT003','KH003','6-13-2022','6-14-2022','P003',400000),
('LT004','KH004','3-9-2022','2-9-2022','P004',200000)
INSERT INTO DICHVU(MaDV, TenDV, GiaTien) VALUES 
('DV001','Nuoc nong Onsen',30000),
('DV002','Spa',500000),
('DV003','An sang tai cho',100000),
('DV004','Massage',300000);
INSERT INTO CTDICHVU(MaCT, MaLT, MaDV, NgaySD) VALUES 
('CT001','LT001','DV001','3-7-2022'),
('CT002','LT002','DV002','5-10-2022'),
('CT003','LT003','DV003','5-9-2022'),
('CT004','LT004','DV004','5-10-2021');
/*3*/
SELECT u.MaKH, u.HoTen, u.CCCD, u.GioiTinh, u.NgaySinh, u.DiaChi, u.SoDienThoai FROM KHACHHANG u ORDER BY u.NgaySinh ASC, u.HoTen DESC
/*4*/
/*C1*/
SELECT u.MaKH, u.HoTen, u.DiaChi, u.SoDienThoai FROM KHACHHANG u 
WHERE u.MaKH NOT IN (SELECT lt.MaKH FROM DKLUUTRU lt)
/*C2*/
WITH DAKLM
AS 
(
    SELECT lt.MaKH FROM DKLUUTRU lt
)
/*5*/
SELECT u.MaKH, u.HoTen, u.DiaChi, u.SoDienThoai FROM KHACHHANG u
WHERE u.MaKH NOT IN (SELECT * FROM DAKLM)
SELECT TOP 1 dv.MaDV, dv.TenDV, dv.GiaTien, COUNT(ctdv.MaDV) FROM DICHVU dv 
RIGHT JOIN CTDICHVU ctdv ON dv.MaDV = ctdv.MaDV
WHERE ((MONTH(ctdv.NgaySD) IN (4,5,6)) AND YEAR(ctdv.NgaySD) = 2021)
GROUP BY dv.MaDV, dv.TenDV, dv.GiaTien
ORDER BY dv.MaDV DESC 
/*6*/
SELECT u.MaKH, u.HoTen, u.CCCD, l.TenLoaiKH, dk.TongTien TongTien FROM KHACHHANG u
FULL JOIN LOAIKH l ON l.MaLoaiKH = u.MaLoaiKH
FULL JOIN DKLUUTRU dk ON dk.MaKH = u.MaKH
WHERE YEAR(dk.NgayKT) = 2021
/*7*/
SELECT u.MaKH, u.HoTen, u.NgaySinh, u.DiaChi, u.SoDienThoai, COUNT(ctdv.MaLT) FROM CTDICHVU ctdv
FULL JOIN DKLUUTRU dk ON dk.MaLT = ctdv.MaLT
FULL JOIN KHACHHANG u ON u.MaKH = dk.MaKH
FULL JOIN DICHVU dv ON dv.MaDV = ctdv.MaDV
GROUP BY u.MaKH, u.HoTen, u.NgaySinh, u.DiaChi, u.SoDienThoai,ctdv.MaLT, dv.TenDV
HAVING dv.TenDV = 'An sang tai cho'
UNION ALL
SELECT u.MaKH, u.HoTen, u.NgaySinh, u.DiaChi, u.SoDienThoai, COUNT(ctdv.MaLT) FROM CTDICHVU ctdv
FULL JOIN DKLUUTRU dk ON dk.MaLT = ctdv.MaLT
FULL JOIN KHACHHANG u ON u.MaKH = dk.MaKH
GROUP BY u.MaKH, u.HoTen, u.NgaySinh, u.DiaChi, u.SoDienThoai,ctdv.MaLT
HAVING ctdv.MaLT IS NULL
/*8*/
SELECT u.MaKH, u.HoTen FROM KHACHHANG u 
RIGHT JOIN DKLUUTRU dk ON dk.MaKH = u.MaKH
FULL JOIN PHONG p ON p.MaPhong = dk.MaPhong
GROUP BY u.MaKH, u.HoTen, dk.MaLT
HAVING COUNT(dk.MaLT) >= 3 AND u.MaKH IN 
(
    SELECT dktt.MaKH FROM DKLUUTRU dktt 
    LEFT JOIN PHONG p ON p.MaPhong = dktt.MaPhong
    WHERE p.LoaiPhong = 'Single' AND (dktt.MaKH NOT IN (SELECT dktt.MaKH FROM DKLUUTRU dktt 
    LEFT JOIN PHONG p ON p.MaPhong = dktt.MaPhong
    WHERE p.LoaiPhong != 'Single') )
)
/*9*/
SELECT u.MaKH, u.HoTen, l.TenLoaiKH FROM KHACHHANG u 
INNER JOIN DKLUUTRU dk ON dk.MaKH = u.MaKH
FULL JOIN LOAIKH l ON l.MaLoaiKH = u.MaLoaiKH
FULL JOIN CTDICHVU ct ON ct.MaLT = dk.MaLT
WHERE u.GioiTinh = 'Nam' AND (ct.NgaySD BETWEEN '01-06-2021' AND '31-08-2021') 
AND u.MaKH NOT IN 
(
    SELECT kh.MaKH FROM CTDICHVU ctdv 
    JOIN DKLUUTRU lt ON ctdv.MaLT = lt.MaLT
    JOIN KHACHHANG kh ON lt.MaKH = kh.MaKH
    JOIN DICHVU dvu ON dvu.MaDV = ctdv.MaDV
    WHERE dvu.TenDV = 'Nuoc nong Onsen'
)
